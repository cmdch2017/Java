package com.a51work6.qq.server;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

public class Select {

    public List<Student> selectStudent(String mail,
                                       Integer classesId) {
        Connection        connection = null;
        PreparedStatement ps         = null;
        ResultSet         rs         = null;
        List<Student>     students   = new ArrayList<>();
        try {
            // åˆ›å»ºæ•°æ®åº“è¿æ?
            connection = DBUtil.getConnection();
            // SQLè¯­å¥ï¼Œå ä½ç¬¦æ˜??
            String sql = "select id,sn,name,qq_mail,classes_id" +
                    " from student where qq_mail" +
                    " like ? and classes_id=?";
            // åˆ›å»ºæ“ä½œå‘½ä»¤å¯¹è±¡Statementï¼Œå¹¶å°†å ä½ç¬¦æ›¿æ¢ä¸ºå®é™…çš„å€?
            ps = connection.prepareStatement(sql);
            ps.setString(1, "%" + mail);
            ps.setInt(2, classesId);
            // ç”¨Statementæ‰§è¡ŒSQLè¯­å¥ï¼Œå¹¶è¿”å›ç»“æœé›†ResultSet
            rs = ps.executeQuery();
            // å¤„ç†ç»“æœé›†ï¼šResultSetå¯¹è±¡ç±»ä¼¼ä¸?ä¸ªList<Map>çš„é›†åˆï¼Œ
            // rs.next()å¤„ç†ç»“æœé›†æ¯ä¸?è¡Œæ•°æ®ï¼Œç±»ä¼¼Listçš„æ¯ä¸ªæ•°æ?
            while (rs.next()) {
                // ä½¿ç”¨rs.getInt/rs.getString/...ç­‰æ–¹æ³?
                // å¤„ç†æ¯è¡Œæ•°æ®ï¼Œå°±ç±»ä¼¼Map.get()æ ¹æ®é”®å?¼è·å–æ•°æ?
                Student student = new Student();
                student.setId(rs.getInt("id"));
                student.setSn(rs.getInt("sn"));
                student.setName(rs.getString("name"));
                student.setQqMail(rs.getString("qq_mail"));
                student.setClassesId(rs.getInt("classes_id"));
                students.add(student);
                System.out.println(student);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            // finallyå§‹ç»ˆä¼šæ‰§è¡Œï¼Œå¦‚æœæ”¾tryé‡Œè¾¹ï¼?
            // å³ä¾¿æ”¾åœ¨æœ?åï¼Œä¹Ÿå¯èƒ½æ‰§è¡Œä¸åˆ?
            DBUtil.close(connection, ps, rs);
        }
        return students;
    }

    /**
     * æŸ¥è¯¢æŒ‡å®šç­çº§åˆ†æ•°åŠæ ¼çš„ä¿¡æ?
     * @param score æŸ¥è¯¢æ¡ä»¶ï¼šåœ¨è¯¥åˆ†æ•°ä»¥ä¸?
     * @param classesId æŸ¥è¯¢æ¡ä»¶ï¼šç­çº§id
     * @return è·å–åˆ†æ•°é›†åˆ
     */
    public List<Score> selectScore(Integer score,
                                   Integer classesId) {
        Connection        connection = null;
        PreparedStatement ps         = null;
        ResultSet         rs         = null;
        List<Score>       scores     = new ArrayList<>();
        try {
            connection = DBUtil.getConnection();
            String sql = "SELECT" +
                    " stu.id," +
                    " stu.NAME student_name," +
                    " cou.NAME course_name," +
                    " sco.score " +
                    " FROM" +
                    " score sco" +
                    " JOIN student stu ON sco.student_id = stu.id" +
                    " JOIN course cou ON sco.course_id = cou.id " +
                    " WHERE" +
                    " sco.score >= ? " +
                    " AND stu.classes_id =?";
            ps = connection.prepareStatement(sql);
            ps.setInt(1, score);
            ps.setInt(2, classesId);
            rs = ps.executeQuery();
            while (rs.next()) {
                Score score0 = new Score();
                score0.setStudentId(rs.getInt("id"));
                score0.setStudentName(rs.getString("student_name"));
                score0.setCourseName(rs.getString("course_name"));
                score0.setScore(rs.getBigDecimal("score"));
                scores.add(score0);
                System.out.println(score0);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            // finallyå§‹ç»ˆä¼šæ‰§è¡Œï¼Œå¦‚æœæ”¾tryé‡Œè¾¹ï¼?
            // å³ä¾¿æ”¾åœ¨æœ?åï¼Œä¹Ÿå¯èƒ½æ‰§è¡Œä¸åˆ?
            DBUtil.close(connection, ps, rs);
        }
        return scores;
    }

    /**
     * æŸ¥è¯¢æŒ‡å®šç­çº§åˆ†æ•°åŠæ ¼çš„ä¿¡æ?
     * @param score
     * @param classesId
     * @return å­¦ç”Ÿä¿¡æ¯çš„é›†åˆï¼Œæ¯ä¸ªå­¦ç”Ÿä¸­åŒ…å«å¤šä¸ªåˆ†æ•°ä¿¡æ¯List<Score>
     */
    public List<Student> selectScore2(Integer score,
                                      Integer classesId) {
        Connection        connection = null;
        PreparedStatement ps         = null;
        ResultSet         rs         = null;
        List<Student>     students   = new ArrayList<>();
        try {
            connection = DBUtil.getConnection();
            String sql = "SELECT" +
                    " stu.id," +
                    " stu.sn," +
                    " stu.NAME student_name," +
                    " stu.qq_mail," +
                    " cou.NAME course_name," +
                    " sco.score " +
                    " FROM" +
                    " score sco" +
                    " JOIN student stu ON sco.student_id = stu.id" +
                    " JOIN course cou ON sco.course_id = cou.id " +
                    " WHERE" +
                    " sco.score >= ? " +
                    " AND stu.classes_id =?";
            ps = connection.prepareStatement(sql);
            ps.setInt(1, score);
            ps.setInt(2, classesId);
            rs = ps.executeQuery();
            while (rs.next()) {
                Integer id       = rs.getInt("id");
                Student student0 = null;
                boolean isExists = false;

                // æ ¹æ®idåœ¨è¿”å›é›†åˆä¸­è·å–å·²æœ‰çš„å­¦ç”?
                for (Student student : students) {
                    if (Integer.compare(id, student.getId()) == 0) {
                        student0 = student;
                        isExists =true;
                    }
                }
                // è¿”å›é›†åˆä¸­æ²¡æœ‰è¯¥å­¦ç”Ÿï¼Œåˆ™åˆ›å»ºè¯¥å­¦ç”Ÿå¯¹è±¡ï¼Œå¹¶ä»ç»“æœé›†ä¸­è·å–
                // å±äºå­¦ç”Ÿçš„ä¿¡æ¯ï¼Œå¯¹å­¦ç”Ÿå¯¹è±¡è®¾å€¼ï¼Œå†å°†è¯¥å­¦ç”Ÿå¯¹è±¡æ·»åŠ åˆ°è¿”å›é›†åˆ
                if(!isExists){
                    student0 = new Student();
                    student0.setId(rs.getInt("id"));
                    student0.setSn(rs.getInt("sn"));
                    student0.setName(rs.getString("student_name"));
                    student0.setQqMail(rs.getString("qq_mail"));
                    students.add(student0);
                }

                // è·å–å­¦ç”Ÿå¯¹è±¡ä¸­çš„åˆ†æ•°é›†åˆï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™æ–°å»ºå¹¶è®¾ç½®åˆ°å­¦ç”Ÿå¯¹è±¡ä¸­
                List<Score> existsScores = student0.getScores();
                if (existsScores == null) {
                    existsScores = new ArrayList<>();
                    student0.setScores(existsScores);
                }

                // å°†å½“å‰ç»“æœé›†ä¸­çš„åˆ†æ•°ä¿¡æ¯æ·»åŠ åˆ°å­¦ç”Ÿå¯¹è±¡ä¸­çš„åˆ†æ•°é›†å?
                Score   score0   = new Score();
                score0.setScore(rs.getBigDecimal("score"));
                score0.setCourseName(rs.getString("course_name"));
                existsScores.add(score0);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            // finallyå§‹ç»ˆä¼šæ‰§è¡Œï¼Œå¦‚æœæ”¾tryé‡Œè¾¹ï¼?
            // å³ä¾¿æ”¾åœ¨æœ?åï¼Œä¹Ÿå¯èƒ½æ‰§è¡Œä¸åˆ?
            DBUtil.close(connection, ps, rs);
        }
        return students;
    }
}